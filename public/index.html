<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Win100 ‚Äì Live Scanner (EV/CLV/Tier + Dedup)</title>

  <style>
    :root{
      --bg0:#060b17;
      --bg1:#0a1330;
      --card:rgba(255,255,255,.04);
      --card2:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.60);
      --accent:#22c55e;
      --accent2:#06b6d4;
      --danger:#ef4444;
      --warn:#f59e0b;
      --good:#22c55e;
      --shadow:0 10px 40px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:radial-gradient(1400px 600px at 30% -10%, rgba(34,197,94,.18), transparent 70%),
                 radial-gradient(1200px 600px at 80% 0%, rgba(6,182,212,.12), transparent 65%),
                 linear-gradient(180deg,var(--bg1),var(--bg0));
      min-height:100vh;
    }
    a{color:inherit}
    .wrap{max-width:1300px;margin:0 auto;padding:22px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:16px;
      padding:14px 16px;border:1px solid var(--line);border-radius:22px;
      background:rgba(255,255,255,.03);box-shadow:var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:26px;height:26px;border-radius:50%;
      background:radial-gradient(circle at 30% 30%, #fff, #a7f3d0 40%, #22c55e);
      box-shadow:0 8px 24px rgba(34,197,94,.25);
    }
    .brand h1{
      margin:0;font-size:15px;font-weight:700;letter-spacing:.2px;
      color:#a7f3d0;
    }
    .brand small{display:block;color:var(--muted);margin-top:2px}
    .nav{
      display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end
    }
    .pill{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);text-decoration:none;font-size:13px;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--accent);box-shadow:0 0 0 4px rgba(34,197,94,.15)}
    .grid{display:grid;grid-template-columns:1.1fr 2fr;gap:18px;margin-top:18px}
    .card{
      border:1px solid var(--line);
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .headRow{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .title{font-size:14px;font-weight:700;margin:0}
    .sub{margin:6px 0 0;color:var(--muted);font-size:13px}
    .actions{display:flex;align-items:center;gap:10px}
    .btn{
      padding:10px 14px;border-radius:12px;border:1px solid rgba(34,197,94,.35);
      background:linear-gradient(180deg, rgba(34,197,94,.25), rgba(34,197,94,.12));
      color:#d1fae5;font-weight:700;cursor:pointer;
      display:flex;align-items:center;gap:8px;
    }
    .btn.loading{opacity:.75;cursor:wait}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .chk{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:13px;user-select:none}
    .chk input{transform:scale(1.05)}
    .errorBox{
      margin-top:10px;padding:10px 12px;border-radius:14px;
      border:1px solid rgba(239,68,68,.35);
      background:rgba(239,68,68,.10);
      display:none;
    }
    .errorBox b{color:#fecaca}
    .filters{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    select,input{
      width:100%;
      padding:10px 12px;border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
    }
    .stats{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-top:14px}
    .stat{
      border:1px solid var(--line);
      border-radius:16px;padding:12px;background:rgba(255,255,255,.03);
    }
    .stat .k{font-size:12px;color:var(--muted)}
    .stat .v{font-size:26px;font-weight:800;margin-top:6px}
    .muted{color:var(--muted)}
    .riskGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:10px}
    .riskBox{
      border:1px solid var(--line);
      border-radius:16px;padding:12px;background:rgba(255,255,255,.03);
    }
    .riskBox .k{font-size:12px;color:var(--muted)}
    .riskBox .v{font-size:20px;font-weight:800;margin-top:6px}
    .tableCard{margin-top:18px}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    thead th{
      font-size:12px;color:var(--muted);text-align:left;
      padding:0 10px 8px;
    }
    tbody td{
      padding:12px 10px;
      background:rgba(255,255,255,.03);
      border-top:1px solid rgba(255,255,255,.06);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    tbody tr td:first-child{border-left:1px solid rgba(255,255,255,.06);border-radius:14px 0 0 14px}
    tbody tr td:last-child{border-right:1px solid rgba(255,255,255,.06);border-radius:0 14px 14px 0}
    code{
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      color:#a7f3d0;
      background:rgba(34,197,94,.10);
      padding:3px 8px;border-radius:999px;border:1px solid rgba(34,197,94,.18)
    }
    .badge{padding:5px 10px;border-radius:999px;font-size:12px;font-weight:800;display:inline-block}
    .badge.pending{background:rgba(245,158,11,.14);border:1px solid rgba(245,158,11,.35);color:#fde68a}
    .badge.win{background:rgba(34,197,94,.14);border:1px solid rgba(34,197,94,.35);color:#bbf7d0}
    .badge.lose{background:rgba(239,68,68,.14);border:1px solid rgba(239,68,68,.35);color:#fecaca}

    .aiWrap{margin-top:18px}
    .ai-item{
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      border-radius:16px;padding:12px;margin-top:10px
    }
    .ai-title{font-size:12px;color:var(--muted)}
    .ai-sub{margin-top:6px}
    .ai-body{margin-top:8px;color:rgba(255,255,255,.82);font-size:13px;line-height:1.45}
    @media (max-width: 1050px){
      .grid{grid-template-columns:1fr}
      .stats{grid-template-columns:repeat(3,1fr)}
      .riskGrid{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Win100 ‚Äì Live Scanner (EV/CLV/Tier + Dedup)</h1>
          <small>‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≠‡∏•‡∏™‡∏î | ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ | ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏π‡∏ï‡∏£‡∏î‡πâ‡∏ß‡∏¢ AI</small>
        </div>
      </div>
      <div class="nav">
        <a class="pill" href="#"><span class="dot"></span>‡∏´‡∏ô‡πâ‡∏≤ Scanner ‡∏™‡∏î</a>
        <a class="pill" href="#"><span>üìä</span>Dashboard ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</a>
        <a class="pill" href="#"><span>üß†</span>AI Optimizer</a>
      </div>
    </div>

    <div class="card" style="margin-top:18px">
      <div class="headRow">
        <div>
          <p class="title">‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≠‡∏•‡∏™‡∏î‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤ (‡∏°‡∏µ Cache/TTL + Dedup)</p>
          <p class="sub" id="statusText">‚Äî</p>
          <div class="errorBox" id="errorBox"><b>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</b> <span id="errorText"></span></div>
        </div>
        <div class="actions">
          <label class="chk"><input id="autoChk" type="checkbox"/> Auto 20s</label>
          <button class="btn" id="scanBtn" type="button">üîÑ ‡∏™‡πÅ‡∏Å‡∏ô</button>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <p class="title">‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</p>
        <div class="filters">
          <div>
            <label>‡∏™‡∏π‡∏ï‡∏£</label>
            <select id="filterStrategy">
              <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <option value="value_1x2">value_1x2</option>
              <option value="late_pressure_goal">late_pressure_goal</option>
              <option value="equalizer_push">equalizer_push</option>
              <option value="redcard_filter">redcard_filter</option>
              <option value="under_control">under_control</option>
              <option value="upstream">upstream</option>
            </select>
          </div>
          <div>
            <label>Tier</label>
            <select id="filterTier">
              <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
            </select>
          </div>
          <div>
            <label>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ Edge</label>
            <input id="minEdge" value="0.02" />
          </div>
          <div>
            <label>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ Kelly</label>
            <input id="minKelly" value="0.05" />
          </div>
        </div>
      </div>

      <div class="card">
        <div class="headRow">
          <p class="title">Risk ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
        </div>
        <div class="riskGrid">
          <div class="riskBox">
            <div class="k">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div>
            <div class="v" id="riskDate">‚Äî</div>
          </div>
          <div class="riskBox">
            <div class="k">PnL ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
            <div class="v" id="riskPnl">‚Äî</div>
          </div>
          <div class="riskBox">
            <div class="k">‡πÅ‡∏û‡πá‡∏Ñ</div>
            <div class="v" id="riskStake">0</div>
          </div>
          <div class="riskBox">
            <div class="k">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
            <div class="v" id="riskState">ACTIVE</div>
          </div>
        </div>
      </div>
    </div>

    <div class="stats">
      <div class="stat"><div class="k">Fixture ‡∏™‡∏î</div><div class="v" id="cLive">0</div></div>
      <div class="stat"><div class="k">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="v" id="cSignals">0</div></div>
      <div class="stat"><div class="k">‡∏ú‡πà‡∏≤‡∏ô Gate</div><div class="v" id="cGate">0</div></div>
      <div class="stat"><div class="k">Tier A</div><div class="v" id="cTierA">0</div></div>
      <div class="stat"><div class="k">Tier B</div><div class="v" id="cTierB">0</div></div>
      <div class="stat"><div class="k">Tier C</div><div class="v" id="cTierC">0</div></div>
    </div>

    <div class="card tableCard">
      <div class="headRow">
        <p class="title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Dedup ‡πÅ‡∏•‡πâ‡∏ß)</p>
        <p class="sub">‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‚Äú‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î/‡∏Ñ‡∏π‡πà/‡∏™‡∏π‡∏ï‡∏£/‡∏ù‡∏±‡πà‡∏á‚Äù</p>
      </div>
      <div style="overflow:auto;margin-top:8px">
        <table>
          <thead>
            <tr>
              <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
              <th>‡∏•‡∏µ‡∏Å</th>
              <th>‡∏Ñ‡∏π‡πà</th>
              <th>‡∏™‡∏π‡∏ï‡∏£</th>
              <th>‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏∞‡πÑ‡∏£</th>
              <th>‡∏ù‡∏±‡πà‡∏á</th>
              <th>Tier</th>
              <th>Stake</th>
              <th>Edge</th>
              <th>Kelly</th>
              <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</th>
              <th>‡∏™‡∏Å‡∏≠‡∏£‡πå/‡∏ô‡∏≤‡∏ó‡∏µ</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            </tr>
          </thead>
          <tbody id="tblBody">
            <tr><td colspan="13" class="muted">‚Äî</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card aiWrap">
      <div class="headRow">
        <p class="title">‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≤‡∏Å AI (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 6 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</p>
      </div>
      <div id="aiList" style="margin-top:8px"><div class="muted">‚Äî</div></div>
    </div>
  </div>

  <script>
/** Win100 Live Scanner UI (clean) **/
const API_BASE = ""; // same-origin. If you want another host, set: localStorage.setItem("WIN100_API_BASE","http://127.0.0.1:3000")
const apiBase = (localStorage.getItem("WIN100_API_BASE") || API_BASE).replace(/\/$/, "");

const els = {
  scanBtn: document.getElementById("scanBtn"),
  autoChk: document.getElementById("autoChk"),
  errorBox: document.getElementById("errorBox"),
  errorText: document.getElementById("errorText"),
  statusText: document.getElementById("statusText"),

  filterStrategy: document.getElementById("filterStrategy"),
  filterTier: document.getElementById("filterTier"),
  minEdge: document.getElementById("minEdge"),
  minKelly: document.getElementById("minKelly"),

  cLive: document.getElementById("cLive"),
  cSignals: document.getElementById("cSignals"),
  cGate: document.getElementById("cGate"),
  cTierA: document.getElementById("cTierA"),
  cTierB: document.getElementById("cTierB"),
  cTierC: document.getElementById("cTierC"),

  tblBody: document.getElementById("tblBody"),
  aiList: document.getElementById("aiList"),

  riskDate: document.getElementById("riskDate"),
  riskPnl: document.getElementById("riskPnl"),
  riskStake: document.getElementById("riskStake"),
  riskState: document.getElementById("riskState"),
};

let lastScan = null;
let autoTimer = null;

function fmt(n, d=2){
  if(n === null || n === undefined || n === "" || Number.isNaN(Number(n))) return "‚Äî";
  return Number(n).toFixed(d);
}
function safeStr(v){ return (v===null || v===undefined) ? "" : String(v); }
function toNum(v, fallback=null){
  const x = Number(v);
  return Number.isFinite(x) ? x : fallback;
}

function showError(msg){
  els.errorBox.style.display = "block";
  els.errorText.textContent = msg;
}
function clearError(){
  els.errorBox.style.display = "none";
  els.errorText.textContent = "";
}

async function fetchJSON(url, options={}, timeoutMs=30000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), timeoutMs);
  try{
    const res = await fetch(url, { ...options, signal: ctrl.signal, cache: "no-store" });
    const ct = (res.headers.get("content-type") || "").toLowerCase();
    const text = await res.text();

    if(!res.ok){
      let msg = `HTTP ${res.status} ${res.statusText}`.trim();
      try{
        const j = JSON.parse(text);
        msg = j.error || j.message || msg;
      }catch{}
      throw new Error(msg);
    }

    if(ct.includes("text/html") || text.trim().startsWith("<!DOCTYPE") || text.trim().startsWith("<html")){
      throw new Error("API ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô HTML (‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ú‡∏¥‡∏î endpoint ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏î‡∏ô fallback). ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤ URL ‡πÄ‡∏õ‡πá‡∏ô /api/scan ‡πÅ‡∏•‡∏∞ server ‡∏°‡∏µ route /api/* ‡∏à‡∏£‡∏¥‡∏á");
    }

    try{
      return JSON.parse(text);
    }catch(e){
      const preview = text.trim().slice(0, 120);
      throw new Error(`API ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON: ${preview}${preview.length>=120 ? "..." : ""}`);
    }
  }finally{
    clearTimeout(t);
  }
}

function normalizeScan(data){
  if(data && typeof data === "object" && ("ok" in data)){
    return {
      ok: !!data.ok,
      ts: data.ts,
      liveCount: toNum(data.liveCount, 0),
      signalsCount: toNum(data.signalsCount, 0),
      signals: Array.isArray(data.signals) ? data.signals : [],
      risk: data.risk || null,
      meta: data.meta || null,
      errors: Array.isArray(data.errors) ? data.errors : [],
    };
  }
  if(data && typeof data === "object" && data.status){
    const ok = String(data.status).toLowerCase() === "success";
    return {
      ok,
      ts: data.ts,
      liveCount: toNum(data.totalFixtures, 0),
      signalsCount: toNum(data.totalPicks, 0),
      signals: Array.isArray(data.picks) ? data.picks : [],
      risk: data.risk || null,
      meta: data.meta || null,
      errors: Array.isArray(data.errors) ? data.errors : [],
    };
  }
  return { ok:false, ts:null, liveCount:0, signalsCount:0, signals:[], risk:null, meta:null, errors:[], _raw:data };
}

function tierOf(p){
  return (p.tier || p.tierLabel || "").toString().toUpperCase() || "‚Äî";
}

function betText(p){
  const bt = (p.betType || p.betype || p.type || p.market || "").toString().toLowerCase();
  const sel = (p.selection || p.pick || p.side || p.betSide || "").toString();
  const line = p.line ?? p.handicap ?? p.value ?? null;

  if(bt === "attack"){
    const side = (p.betSide || p.side || sel || "").toString().toLowerCase();
    if(side === "home") return "‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô (1X2 / ‡∏ä‡∏ô‡∏∞)";
    if(side === "away") return "‡∏ó‡∏µ‡∏°‡πÄ‡∏¢‡∏∑‡∏≠‡∏ô (1X2 / ‡∏ä‡∏ô‡∏∞)";
    if(side === "draw") return "‡πÄ‡∏™‡∏°‡∏≠";
    return "1X2 (‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì)";
  }

  if(bt === "over" || bt === "under"){
    const m = sel.match(/(over|under)[_\s-]?(\d+)[_\s-]?(\d+)?/i);
    if(m){
      const a = m[2];
      const b = m[3];
      const num = b ? `${a}.${b}` : `${a}`;
      return `${bt === "over" ? "‡∏™‡∏π‡∏á" : "‡∏ï‡πà‡∏≥"} ${num}`;
    }
    if(line !== null) return `${bt === "over" ? "‡∏™‡∏π‡∏á" : "‡∏ï‡πà‡∏≥"} ${line}`;
    return bt === "over" ? "‡∏™‡∏π‡∏á (O/U)" : "‡∏ï‡πà‡∏≥ (O/U)";
  }

  if(bt.includes("ah") || bt.includes("handicap")){
    const side = (p.betSide || sel || "").toString().toLowerCase();
    const l = line !== null ? line : "";
    const sideTH = side === "home" ? "‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô" : side === "away" ? "‡∏ó‡∏µ‡∏°‡πÄ‡∏¢‡∏∑‡∏≠‡∏ô" : "‡πÅ‡∏Æ‡∏ô‡∏î‡∏¥‡πÅ‡∏Ñ‡∏õ";
    return `${sideTH} ${l}`.trim();
  }

  if(bt.includes("dnb") || bt.includes("draw no bet")){
    const side = (p.betSide || sel || "").toString().toLowerCase();
    const sideTH = side === "home" ? "‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô" : side === "away" ? "‡∏ó‡∏µ‡∏°‡πÄ‡∏¢‡∏∑‡∏≠‡∏ô" : "DNB";
    return `${sideTH} (DNB)`;
  }

  const raw = [p.betType, p.selection].filter(Boolean).join(" ¬∑ ");
  return raw || "‚Äî";
}

function statusBadge(p){
  const s = (p.result || p.status || "PENDING").toString().toUpperCase();
  const cls = s === "WIN" ? "badge win" : s === "LOSE" ? "badge lose" : "badge pending";
  return `<span class="${cls}">${s}</span>`;
}

function passesFilters(p){
  const strat = els.filterStrategy.value;
  const tier = els.filterTier.value;
  const minEdge = toNum(els.minEdge.value, 0);
  const minKelly = toNum(els.minKelly.value, 0);

  if(strat && (p.strategy || "").toString() !== strat) return false;
  if(tier && tierOf(p) !== tier) return false;

  const edge = toNum(p.edge ?? p.ev, 0);
  const kelly = toNum(p.kelly, 0);
  if(edge < minEdge) return false;
  if(kelly < minKelly) return false;

  return true;
}

function updateCounters(scan){
  const signals = (scan.signals || []).filter(passesFilters);
  els.cLive.textContent = toNum(scan.liveCount, 0);
  els.cSignals.textContent = signals.length;

  let gate = 0, a=0, b=0, c=0;
  for(const p of signals){
    const t = tierOf(p);
    if(t === "A") a++;
    else if(t === "B") b++;
    else if(t === "C") c++;
    if(p.passedGate || p.gatePassed) gate++;
  }
  els.cGate.textContent = gate;
  els.cTierA.textContent = a;
  els.cTierB.textContent = b;
  els.cTierC.textContent = c;

  const r = scan.risk || {};
  els.riskDate.textContent = r.date || "‚Äî";
  els.riskPnl.textContent = (r.pnl !== undefined && r.pnl !== null) ? String(r.pnl) : "‚Äî";
  els.riskStake.textContent = (r.totalStake !== undefined && r.totalStake !== null) ? String(r.totalStake) : "0";
  els.riskState.textContent = (r.state || "ACTIVE").toString().toUpperCase();
}

function renderTable(scan){
  const signals = (scan.signals || []).filter(passesFilters);
  if(!signals.length){
    els.tblBody.innerHTML = `<tr><td colspan="13" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‚Äú‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‚Äù ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡∏•‡∏≠‡∏á‡∏•‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ Edge/Kelly ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà)</td></tr>`;
    return;
  }

  const rows = signals.map(p=>{
    const time = p.time || (p.ts ? new Date(p.ts).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"}) : "‚Äî");
    const league = safeStr(p.league || p.competition || "");
    const match = safeStr(p.match || (p.home && p.away ? `${p.home} vs ${p.away}` : ""));
    const strat = safeStr(p.strategy || "‚Äî");
    const play = betText(p);
    const side = safeStr(p.betSide || p.side || "‚Äî").toUpperCase();
    const tier = tierOf(p);
    const stake = p.stake ?? p.stakeUnit ?? "‚Äî";
    const edge = fmt(p.edge ?? p.ev, 4);
    const kelly = fmt(p.kelly, 4);
    const price = (p.price ?? p.odds ?? null);
    const priceText = (price === null || price === undefined) ? "‚Äî" : String(price);
    const score = p.score || p.scoreAtScan || (p.goalsHome !== undefined ? `${p.goalsHome}-${p.goalsAway}` : "‚Äî");
    const minute = p.minute ?? p.minuteAtScan ?? "‚Äî";
    const scoreMin = (score && minute !== "‚Äî") ? `${score} / ${minute}'` : (score || "‚Äî");
    return `<tr>
      <td>${time}</td>
      <td>${league}</td>
      <td>${match}</td>
      <td><code>${strat}</code></td>
      <td><strong>${play}</strong></td>
      <td>${side || "‚Äî"}</td>
      <td>${tier}</td>
      <td>${stake}</td>
      <td>${edge}</td>
      <td>${kelly}</td>
      <td>${priceText}</td>
      <td>${scoreMin}</td>
      <td>${statusBadge(p)}</td>
    </tr>`;
  }).join("");

  els.tblBody.innerHTML = rows;
}

function renderAI(scan){
  const signals = (scan.signals || []).filter(passesFilters).slice(0, 6);
  if(!signals.length){
    els.aiList.innerHTML = `<div class="muted">‚Äî</div>`;
    return;
  }
  const items = signals.map(p=>{
    const time = p.time || (p.ts ? new Date(p.ts).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"}) : "");
    const league = safeStr(p.league || "");
    const match = safeStr(p.home && p.away ? `${p.home} vs ${p.away}` : (p.match || ""));
    const play = betText(p);
    const ai = safeStr(p.ai || p.note || "");
    return `<div class="ai-item">
      <div class="ai-title">${time} ‚Ä¢ ${league} ‚Ä¢ ${match}</div>
      <div class="ai-sub"><strong>${play}</strong></div>
      <div class="ai-body">${ai ? ai : `<span class="muted">‚Äî</span>`}</div>
    </div>`;
  }).join("");

  els.aiList.innerHTML = items;
}

function updateStatusText(scan){
  const fixtures = toNum(scan.liveCount, 0);
  const picks = (scan.signals || []).filter(passesFilters).length;
  const when = scan.ts ? new Date(scan.ts).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"}) : "";
  if(scan.ok){
    if(picks === 0){
      els.statusText.textContent = `‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡πâ‡∏ß: Fixtures ${fixtures} ¬∑ Picks 0 (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç) ${when ? "‚Ä¢ "+when : ""}`;
    }else{
      els.statusText.textContent = `‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡πâ‡∏ß: Fixtures ${fixtures} ¬∑ Picks ${picks} ${when ? "‚Ä¢ "+when : ""}`;
    }
  }else{
    els.statusText.textContent = `‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`;
  }
}

async function scan(){
  els.scanBtn.disabled = true;
  els.scanBtn.classList.add("loading");
  clearError();
  els.statusText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô...";
  try{
    const raw = await fetchJSON(`${apiBase}/api/scan`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: "{}"
    }, 45000);

    const scan = normalizeScan(raw);
    lastScan = scan;

    if(!scan.ok){
      const msg = (scan.errors && scan.errors.length) ? scan.errors.join(" | ") : "‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
      showError(msg);
    }

    updateStatusText(scan);
    updateCounters(scan);
    renderTable(scan);
    renderAI(scan);
  }catch(err){
    showError(err?.message ? String(err.message) : "‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    els.statusText.textContent = "‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
    // Keep UI stable: do not wipe previous successful data
  }finally{
    els.scanBtn.disabled = false;
    els.scanBtn.classList.remove("loading");
  }
}

function bind(){
  els.scanBtn.addEventListener("click", scan);

  const onFilter = ()=>{
    if(!lastScan) return;
    clearError();
    updateStatusText(lastScan);
    updateCounters(lastScan);
    renderTable(lastScan);
    renderAI(lastScan);
  };
  els.filterStrategy.addEventListener("change", onFilter);
  els.filterTier.addEventListener("change", onFilter);
  els.minEdge.addEventListener("change", onFilter);
  els.minKelly.addEventListener("change", onFilter);

  els.autoChk.addEventListener("change", ()=>{
    if(els.autoChk.checked){
      autoTimer = setInterval(()=>scan().catch(()=>{}), 20000);
    }else{
      if(autoTimer) clearInterval(autoTimer);
      autoTimer = null;
    }
  });
}

async function init(){
  bind();
  try{ await scan(); }catch{}
}

init();
  </script>
</body>
</html>
