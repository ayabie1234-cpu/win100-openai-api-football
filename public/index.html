<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Win100 ‚Äì Live Scanner</title>
  <style>
    :root{
      --bg:#050a18;
      --card:#0b132a;
      --card2:#0a1023;
      --line:rgba(255,255,255,.08);
      --txt:#dbeafe;
      --muted:#93a4c7;
      --ok:#34d399;
      --warn:#f59e0b;
      --bad:#fb7185;
      --chip:#111b35;
      --chipLine:rgba(255,255,255,.10);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 30% 0%, #0c1634 0%, var(--bg) 55%, #050816 100%);
      color:var(--txt);
    }
    a{color:inherit}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px
    }
    .brand{
      display:flex;align-items:center;gap:10px
    }
    .ball{
      width:28px;height:28px;border-radius:50%;
      display:grid;place-items:center;
      background: linear-gradient(180deg,#111a38,#070d1f);
      border:1px solid var(--line);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      font-size:16px
    }
    .title{
      font-weight:700;
      font-size:16px;
      letter-spacing:.2px
    }
    .subtitle{
      font-size:12px;color:var(--muted);margin-top:2px
    }
    .tabs{display:flex;gap:10px;align-items:center}
    .tab{
      display:flex;gap:8px;align-items:center;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      color:var(--txt);
      text-decoration:none;
      font-size:13px
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: var(--ok);
      box-shadow: 0 0 0 4px rgba(52,211,153,.12);
    }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      margin-bottom:14px
    }
    .panelHead{
      display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px
    }
    .panelTitle{font-weight:700;font-size:14px}
    .panelSub{font-size:12px;color:var(--muted)}
    .rightCtl{display:flex;align-items:center;gap:10px}
    .btn{
      cursor:pointer;
      border:1px solid rgba(52,211,153,.25);
      background: linear-gradient(180deg, rgba(52,211,153,.25), rgba(52,211,153,.15));
      color:#d1fae5;
      padding:9px 14px;
      border-radius:12px;
      font-weight:700;
      display:flex;align-items:center;gap:8px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .chk{
      display:flex;align-items:center;gap:8px;
      font-size:12px;color:var(--muted);
      user-select:none
    }
    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
    }
    .card h3{margin:0 0 10px 0;font-size:13px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    select,input{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.09);
      background: rgba(9,14,32,.55);
      color:var(--txt);
      outline:none;
    }
    .miniGrid{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:10px;
    }
    @media (max-width: 980px){
      .miniGrid{grid-template-columns: repeat(3, 1fr)}
    }
    .mini{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
    }
    .mini .k{font-size:12px;color:var(--muted)}
    .mini .v{font-size:26px;font-weight:800;margin-top:4px}
    .mini .v.ok{color:var(--ok)}
    .mini .v.warn{color:var(--warn)}
    .mini .v.bad{color:var(--bad)}

    .tableWrap{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:12px;
    }
    thead th{
      text-align:left;
      padding:10px 12px;
      color:#b9c6e6;
      background: rgba(255,255,255,.03);
      border-bottom:1px solid var(--line);
      position:sticky;top:0;z-index:1;
      white-space:nowrap;
    }
    tbody td{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align:top;
    }
    tbody tr:hover{background: rgba(255,255,255,.02)}
    .muted{color:var(--muted)}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.09);
      font-size:11px;
      white-space:nowrap;
    }
    .tag.ok{border-color:rgba(52,211,153,.25);color:#d1fae5}
    .tag.warn{border-color:rgba(245,158,11,.25);color:#fde68a}
    .tag.bad{border-color:rgba(251,113,133,.25);color:#fecdd3}

    .statusLine{
      display:flex;align-items:center;gap:10px;
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
    }
    .bannerErr{
      display:none;
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(251,113,133,.10);
      border:1px solid rgba(251,113,133,.20);
      color:#fecdd3;
      font-size:12px;
      white-space:pre-wrap;
    }
    body.hasError .bannerErr{display:block}

    /* Make it SUPER clear what to play */
    .playBox{display:flex;flex-direction:column;gap:4px}
    .playMain{font-size:13px;line-height:1.2}
    .playMain b{color:#d1fae5}

    .aiBox{
      margin-top:14px;
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
    }
    .aiItem{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(9,14,32,.45);
      margin-top:10px;
      font-size:12px;
      color:#cfe2ff;
    }
    .aiItem .h{font-weight:800;margin-bottom:4px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="ball">‚öΩ</div>
        <div>
          <div class="title">Win100 ‚Äì Live Scanner (EV/CLV/Tier + Dedup)</div>
          <div class="subtitle">‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≠‡∏•‡∏™‡∏î | ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ | ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏π‡∏ï‡∏£‡∏î‡πâ‡∏ß‡∏¢ AI</div>
        </div>
      </div>
      <div class="tabs">
        <a class="tab" href="#"><span class="dot"></span> ‡∏´‡∏ô‡πâ‡∏≤ Scanner ‡∏™‡∏î</a>
        <a class="tab" href="#"><span>üìä</span> Dashboard ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</a>
        <a class="tab" href="#"><span>üß†</span> AI Optimizer</a>
      </div>
    </div>

    <div class="panel">
      <div class="panelHead">
        <div>
          <div class="panelTitle">‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≠‡∏•‡∏™‡∏î‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤ (‡∏°‡∏µ Cache/TTL + Dedup)</div>
          <div id="statusText" class="panelSub">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πÅ‡∏Å‡∏ô</div>
        </div>
        <div class="rightCtl">
          <label class="chk"><input id="autoScan" type="checkbox" /> Auto 20s</label>
          <button id="btnScan" class="btn">üîÑ ‡∏™‡πÅ‡∏Å‡∏ô</button>
        </div>
      </div>
      <div class="statusLine">
        <span id="miniStatus">‚Äî</span>
      </div>
      <div id="errBanner" class="bannerErr"></div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</h3>
        <div class="row">
          <div class="field">
            <label>‡∏™‡∏π‡∏ï‡∏£</label>
            <select id="filterStrategy"></select>
          </div>
          <div class="field">
            <label>Tier</label>
            <select id="filterTier"></select>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="field">
            <label>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ Edge</label>
            <input id="minEdge" type="number" step="0.01" value="0.02" />
          </div>
          <div class="field">
            <label>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ Kelly</label>
            <input id="minKelly" type="number" step="0.01" value="0.05" />
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Risk ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
        <div class="row">
          <div class="mini">
            <div class="k">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div>
            <div id="riskDay" class="v" style="font-size:18px">‚Äî</div>
          </div>
          <div class="mini">
            <div class="k">PnL ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
            <div id="riskPnl" class="v" style="font-size:18px">‚Äî</div>
          </div>
          <div class="mini">
            <div class="k">‡πÄ‡∏ö‡πá‡∏ï‡∏ï‡πå</div>
            <div id="riskBets" class="v" style="font-size:18px">0</div>
          </div>
          <div class="mini">
            <div class="k">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
            <div id="riskStatus" class="v" style="font-size:18px">‚Äî</div>
          </div>
        </div>
      </div>
    </div>

    <div class="miniGrid">
      <div class="mini">
        <div class="k">Fixture ‡∏™‡∏î</div>
        <div id="mFixtures" class="v">0</div>
      </div>
      <div class="mini">
        <div class="k">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        <div id="mSignals" class="v">0</div>
      </div>
      <div class="mini">
        <div class="k">‡∏ú‡πà‡∏≤‡∏ô Gate</div>
        <div id="mGate" class="v ok">0</div>
      </div>
      <div class="mini">
        <div class="k">Tier A</div>
        <div id="mA" class="v">0</div>
      </div>
      <div class="mini">
        <div class="k">Tier B</div>
        <div id="mB" class="v">0</div>
      </div>
      <div class="mini">
        <div class="k">Tier C</div>
        <div id="mC" class="v">0</div>
      </div>
    </div>

    <div style="height:14px"></div>

    <div class="tableWrap">
      <div style="padding:14px 14px 10px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div style="font-weight:800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Dedup ‡πÅ‡∏•‡πâ‡∏ß)</div>
        <div class="muted" style="font-size:12px">‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‚Äú‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î/‡∏Ñ‡∏π‡πà/‡∏™‡∏π‡∏ï‡∏£/‡∏ù‡∏±‡πà‡∏á‚Äù</div>
      </div>
      <table>
        <thead>
          <tr>
            <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
            <th>‡∏•‡∏µ‡∏Å</th>
            <th>‡∏Ñ‡∏π‡πà</th>
            <th>‡∏™‡∏π‡∏ï‡∏£</th>
            <th>‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏∞‡πÑ‡∏£</th>
            <th>Tier</th>
            <th>Stake</th>
            <th>Edge</th>
            <th>Kelly</th>
            <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</th>
            <th>‡∏™‡∏Å‡∏≠‡∏£‡πå/‡∏ô‡∏≤‡∏ó‡∏µ</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          </tr>
        </thead>
        <tbody id="tblBody"></tbody>
      </table>
    </div>

    <div class="aiBox">
      <div style="font-weight:800">‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≤‡∏Å AI (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 6 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</div>
      <div id="aiList" class="muted" style="margin-top:10px">‚Äî</div>
    </div>
  </div>

  <script>
    // keep-alive / health
    // (render/localhost pages)
  </script>

  <script>
    const STRATEGY_LABEL = {
      value_1x2: "Value 1X2",
      late_pressure_goal: "Late Pressure Goal",
      equalizer_push: "Equalizer Push",
      redcard_filter: "Redcard Filter",
      under_control: "Under Control",
      upstream: "Upstream"
    };

    const TIER_LABEL = ["A","B","C"];

    const el = (id)=>document.getElementById(id);

    const btnScan = el("btnScan");
    const autoScan = el("autoScan");
    const statusText = el("statusText");
    const miniStatus = el("miniStatus");
    const errBanner = el("errBanner");

    const filterStrategy = el("filterStrategy");
    const filterTier = el("filterTier");
    const minEdge = el("minEdge");
    const minKelly = el("minKelly");

    const tblBody = el("tblBody");
    const aiList = el("aiList");

    const mFixtures = el("mFixtures");
    const mSignals = el("mSignals");
    const mGate = el("mGate");
    const mA = el("mA");
    const mB = el("mB");
    const mC = el("mC");

    const riskDay = el("riskDay");
    const riskPnl = el("riskPnl");
    const riskBets = el("riskBets");
    const riskStatus = el("riskStatus");

    let timer = null;
    let lastPicks = [];

    function setStatus(msg){
      statusText.textContent = msg;
      miniStatus.textContent = msg;
      // show/hide banner based on msg prefix
      if(String(msg||"").startsWith("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î")){
        errBanner.textContent = msg;
        document.body.classList.add("hasError");
      }else{
        errBanner.textContent = "";
        document.body.classList.remove("hasError");
      }
    }

    function labelStrategy(k){
      return STRATEGY_LABEL[k] || k || "-";
    }

    function labelTier(t){
      if(!t) return "-";
      const s = String(t).toUpperCase();
      if(TIER_LABEL.includes(s)) return s;
      return s;
    }

    function tagTier(t){
      const s = labelTier(t);
      if(s==="A") return `<span class="tag ok">Tier ${s}</span>`;
      if(s==="B") return `<span class="tag warn">Tier ${s}</span>`;
      if(s==="C") return `<span class="tag bad">Tier ${s}</span>`;
      return `<span class="tag">Tier ${s}</span>`;
    }

    // --- Play / Bet instruction helpers (UI clarity) ---
    function betSideThai(side){
      const s = String(side||"").toLowerCase();
      const map = {
        home: "‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô", away: "‡∏ó‡∏µ‡∏°‡πÄ‡∏¢‡∏∑‡∏≠‡∏ô", draw: "‡πÄ‡∏™‡∏°‡∏≠",
        over: "‡∏™‡∏π‡∏á", under: "‡∏ï‡πà‡∏≥",
        "1": "‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô", "2": "‡∏ó‡∏µ‡∏°‡πÄ‡∏¢‡∏∑‡∏≠‡∏ô", "x": "‡πÄ‡∏™‡∏°‡∏≠"
      };
      return map[s] || (side ? String(side) : "");
    }

    // Convert strings like "over_0_5" -> {ou:"over", line:"0.5"}
    function parseOuSelection(sel){
      if(!sel) return null;
      const m = String(sel).match(/^(over|under)_(\d+(?:_\d+)*)$/i);
      if(!m) return null;
      const ou = m[1].toLowerCase();
      const line = m[2].split("_").join(".");
      return { ou, line };
    }

    function formatPlayPlain(p){
      if(!p) return "-";
      // Prefer explicit note (already human-friendly)
      if(p.note) return String(p.note);

      // If server provides betType/market/selection/line/price fields
      const betType = p.betType || p.bet_type;
      const market = p.market || p.marketType;
      const selection = p.selection || p.pick || p.betSelection;
      const line = (p.line ?? p.handicap ?? p.total);

      // O/U selection pattern
      const ou = parseOuSelection(selection);
      if(ou){
        const mk = market ? String(market).toUpperCase() : "TOTAL";
        const side = ou.ou === "over" ? "‡∏™‡∏π‡∏á" : "‡∏ï‡πà‡∏≥";
        const odds = (p.price!=null ? p.price : p.odds!=null ? p.odds : null);
        return `‡πÄ‡∏•‡πà‡∏ô: ${side} ${ou.line} (${mk})${odds?` @${odds}`:""}`;
      }

      // 1X2 common selections
      const selNorm = selection ? String(selection).toLowerCase() : "";
      if(["home","away","draw","1","2","x"].includes(selNorm)){
        const side = betSideThai(selNorm);
        const odds = (p.price!=null ? p.price : p.odds!=null ? p.odds : null);
        return `‡πÄ‡∏•‡πà‡∏ô: ${side} (1X2)${odds?` @${odds}`:""}`;
      }

      // Generic: use betSide + possible line
      const side2 = betSideThai(p.betSide);
      if(side2){
        const odds = (p.price!=null ? p.price : p.odds!=null ? p.odds : null);
        return `‡πÄ‡∏•‡πà‡∏ô: ${side2}${line!=null?` ${line}`:""}${odds?` @${odds}`:""}`;
      }

      // Last resort: show whatever is available
      const parts = [];
      if(betType) parts.push(String(betType));
      if(market) parts.push(String(market));
      if(selection) parts.push(String(selection));
      if(line!=null) parts.push(String(line));
      return parts.length ? `‡πÄ‡∏•‡πà‡∏ô: ${parts.join(" ‚Ä¢ ")}` : "-";
    }

    function formatPlayHTML(p){
      const t = formatPlayPlain(p);
      const safe = String(t).replace(/</g,"&lt;").replace(/>/g,"&gt;");
      return `<div class="playBox"><div class="playMain">${safe.replace(/^‡πÄ‡∏•‡πà‡∏ô:\s*/,"<b>‡πÄ‡∏•‡πà‡∏ô:</b> ")}</div></div>`;
    }

    function timeHM(ts){
      if(!ts) return "-";
      const d = new Date(ts);
      if(isNaN(d.getTime())) return String(ts);
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${hh}:${mm}`;
    }

    function setFilters(){
      // Strategy
      const stratKeys = Object.keys(STRATEGY_LABEL);
      filterStrategy.innerHTML =
        `<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>` +
        stratKeys.map(k=>`<option value="${k}">${k}</option>`).join("");

      // Tier
      filterTier.innerHTML =
        `<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>` +
        ["A","B","C"].map(t=>`<option value="${t}">Tier ${t}</option>`).join("");
    }

    function updateRisk(risk){
      if(!risk){
        riskDay.textContent = "‚Äî";
        riskPnl.textContent = "‚Äî";
        riskBets.textContent = "0";
        riskStatus.textContent = "‚Äî";
        return;
      }
      riskDay.textContent = risk.day || "‚Äî";
      riskPnl.textContent = (risk.pnl!=null ? String(risk.pnl) : "‚Äî");
      riskBets.textContent = (risk.bets!=null ? String(risk.bets) : "0");
      riskStatus.textContent = risk.status || "ACTIVE";
    }

    function passGate(p){
      const me = parseFloat(minEdge.value || "0");
      const mk = parseFloat(minKelly.value || "0");
      const edge = parseFloat(p.edge || "0");
      const kelly = parseFloat(p.kelly || "0");
      return edge >= me && kelly >= mk;
    }

    function render(picks, meta){
      const sFilter = filterStrategy.value || "";
      const tFilter = (filterTier.value || "").toUpperCase();

      const filtered = (picks||[]).filter(p=>{
        if(sFilter && p.strategy !== sFilter) return false;
        if(tFilter && String(p.tier||"").toUpperCase() !== tFilter) return false;
        return true;
      });

      const totalFixtures = meta?.totalFixtures ?? 0;
      const totalPicks = meta?.totalPicks ?? filtered.length;

      // minis
      mFixtures.textContent = String(totalFixtures);
      mSignals.textContent = String(totalPicks);

      let gate=0, a=0,b=0,c=0;
      for(const p of filtered){
        if(passGate(p)) gate++;
        const t = String(p.tier||"").toUpperCase();
        if(t==="A") a++; else if(t==="B") b++; else if(t==="C") c++;
      }
      mGate.textContent = String(gate);
      mA.textContent = String(a);
      mB.textContent = String(b);
      mC.textContent = String(c);

      // table
      tblBody.innerHTML = "";
      if(!filtered.length){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="12" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏•‡∏≠‡∏á‡∏Å‡∏î ‚Äú‡∏™‡πÅ‡∏Å‡∏ô‚Äù ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç)</td>`;
        tblBody.appendChild(tr);
      }else{
        for(const p of filtered.slice(0,50)){
          const tr = document.createElement("tr");
          const match = `${p.home||"-"} vs ${p.away||"-"}`;
          const scoreMin = (p.scoreAtScan!=null || p.minuteAtScan!=null)
            ? `${p.scoreAtScan!=null?p.scoreAtScan:"-"} / ${p.minuteAtScan!=null?p.minuteAtScan:"-"}'`
            : "-";

          const stake = (p.stake!=null ? p.stake : p.stakeUnit!=null ? p.stakeUnit : null);
          const stakeTxt = (stake==null ? "‚Äî" : String(stake));

          const edgeTxt = (p.edge!=null ? Number(p.edge).toFixed(4) : "‚Äî");
          const kellyTxt = (p.kelly!=null ? Number(p.kelly).toFixed(4) : "‚Äî");
          const priceTxt = (p.priceTaken!=null ? p.priceTaken : p.price!=null ? p.price : "‚Äî");

          const st = String(p.status||"PENDING").toUpperCase();
          const stTag = st==="ACTIVE"
            ? `<span class="tag ok">ACTIVE</span>`
            : st==="WON"
              ? `<span class="tag ok">WON</span>`
              : st==="LOST"
                ? `<span class="tag bad">LOST</span>`
                : `<span class="tag warn">${st}</span>`;

          tr.innerHTML = `
            <td class="muted">${timeHM(p.ts)}</td>
            <td>${p.league||"-"}</td>
            <td>${match}</td>
            <td><span class="tag">${p.strategy||"-"}</span><div class="muted" style="margin-top:4px">${labelStrategy(p.strategy)}</div></td>
            <td>${formatPlayHTML(p)}</td>
            <td>${tagTier(p.tier)}</td>
            <td>${stakeTxt}</td>
            <td>${edgeTxt}</td>
            <td>${kellyTxt}</td>
            <td>${priceTxt}</td>
            <td class="muted">${scoreMin}</td>
            <td>${stTag}</td>
          `;
          tblBody.appendChild(tr);
        }
      }

      // AI-like quick summary (no model call, just readable)
      if(!filtered.length){
        aiList.textContent = "‚Äî";
      }else{
        aiList.innerHTML = "";
        const top = filtered.slice(0,6);
        for(const p of top){
          const div = document.createElement("div");
          div.className = "aiItem";
          const match = `${p.home||"-"} vs ${p.away||"-"}`;
          div.innerHTML = `
            <div class="h">${timeHM(p.ts)} ‚Ä¢ ${p.league||"-"} ‚Ä¢ ${match}</div>
            <div>${formatPlayHTML(p)}</div>
            <div class="muted" style="margin-top:6px">‡∏™‡∏π‡∏ï‡∏£: ${p.strategy||"-"} (${labelStrategy(p.strategy)}) ‚Ä¢ ${labelTier(p.tier)} ‚Ä¢ Edge ${p.edge!=null?Number(p.edge).toFixed(4):"‚Äî"} ‚Ä¢ Kelly ${p.kelly!=null?Number(p.kelly).toFixed(4):"‚Äî"}</div>
          `;
          aiList.appendChild(div);
        }
      }
    }

    async function scanNow(){
      try{
        setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô‚Ä¶");
        btnScan.disabled = true;

        const r = await fetch("/api/scan", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: "{}"
        });

        const ct = (r.headers.get("content-type")||"").toLowerCase();
        let data;
        if(ct.includes("application/json")){
          data = await r.json();
        }else{
          const txt = await r.text();
          const head = txt.slice(0, 200).replace(/\s+/g," ").trim();
          throw new Error(`‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON (content-type: ${ct||"unknown"}) ‚Ä¢ ${head}`);
        }

        const ok = (data.status === "success") || (data.ok === true);
        if(!ok){
          throw new Error(data.message || data.error || "‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }

        lastPicks = data.picks || data.signals || [];
        updateRisk(data.risk || null);

        const totalFixtures = data.totalFixtures ?? data.liveCount ?? 0;
        const totalPicks = data.totalPicks ?? data.signalsCount ?? (lastPicks.length||0);

        render(lastPicks, { totalFixtures, totalPicks });

        if(totalPicks > 0){
          setStatus(`‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: Fixtures ${totalFixtures} ‚Ä¢ Picks ${totalPicks}`);
        }else{
          setStatus(`‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ‚Ä¢ Fixtures ${totalFixtures} ‚Ä¢ Picks 0`);
        }
      }catch(e){
        console.error(e);
        setStatus("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + (e?.message || e));
        document.body.classList.add("hasError");
      }finally{
        btnScan.disabled = false;
      }
    }

    function startAuto(){
      stopAuto();
      timer = setInterval(()=>scanNow(), 20000);
    }
    function stopAuto(){
      if(timer){ clearInterval(timer); timer=null; }
    }

    btnScan.addEventListener("click", ()=>scanNow());
    autoScan.addEventListener("change", ()=>{
      if(autoScan.checked) startAuto();
      else stopAuto();
    });

    filterStrategy.addEventListener("change", ()=>render(lastPicks, {totalFixtures: Number(mFixtures.textContent||0), totalPicks: Number(mSignals.textContent||0)}));
    filterTier.addEventListener("change", ()=>render(lastPicks, {totalFixtures: Number(mFixtures.textContent||0), totalPicks: Number(mSignals.textContent||0)}));
    minEdge.addEventListener("input", ()=>render(lastPicks, {totalFixtures: Number(mFixtures.textContent||0), totalPicks: Number(mSignals.textContent||0)}));
    minKelly.addEventListener("input", ()=>render(lastPicks, {totalFixtures: Number(mFixtures.textContent||0), totalPicks: Number(mSignals.textContent||0)}));

    // init
    setFilters();
    setStatus("‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πÅ‡∏Å‡∏ô");
  </script>
</body>
</html>
