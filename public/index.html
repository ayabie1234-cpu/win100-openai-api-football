<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Win100 ‚Äî Live Scanner</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#111823;
      --panel2:#0f1620;
      --line:#223041;
      --text:#e7eef7;
      --muted:#a9b7c7;
      --good:#23c483;
      --bad:#ff5a6a;
      --warn:#ffcc66;
      --chip:#1b2633;
      --btn:#182434;
      --btn2:#1f2d42;
      --shadow: 0 10px 40px rgba(0,0,0,.35);
      --radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background: radial-gradient(1200px 600px at 20% 0%, rgba(35,196,131,.13), transparent 60%),
                  radial-gradient(1000px 600px at 80% 0%, rgba(84,124,255,.10), transparent 60%),
                  var(--bg);
    }
    a{color:inherit}
    .wrap{max-width:1200px; margin:0 auto; padding:18px 16px 30px}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:12px;
    }
    .brand{display:flex; align-items:baseline; gap:10px}
    .brand h1{margin:0; font-size:18px; letter-spacing:.2px}
    .brand .sub{color:var(--muted); font-size:12px}
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
    }
    .tab{
      display:inline-flex; align-items:center; gap:8px;
      padding:9px 12px; border-radius:999px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);
      text-decoration:none;
      color:var(--muted);
      font-size:13px;
    }
    .tab.active{
      color:var(--text);
      background:rgba(35,196,131,.10);
      border-color:rgba(35,196,131,.25);
    }
    .dot{width:10px; height:10px; border-radius:50%; background:var(--good); box-shadow:0 0 0 3px rgba(35,196,131,.15)}
    .grid{display:grid; grid-template-columns: 370px 1fr; gap:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.07);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .panelHead{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .panelTitle{font-weight:800; font-size:14px; letter-spacing:.2px}
    .panelSub{color:var(--muted); font-size:12px; margin-top:3px}
    .btn{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.10);
      background:var(--btn);
      color:var(--text);
      padding:9px 12px;
      border-radius:10px;
      font-size:13px;
    }
    .btn:hover{background:var(--btn2)}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btnRow{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .mini{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 980px){ .mini{grid-template-columns: repeat(2, minmax(0,1fr));} }
    .pill{
      border-radius:12px;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.06);
      padding:10px 10px 9px;
    }
    .pill .k{font-size:11px; color:var(--muted); letter-spacing:.2px}
    .pill .v{font-size:22px; font-weight:900; margin-top:4px}
    .statusLine{
      display:flex; align-items:center; gap:10px;
      color:var(--muted); font-size:12px;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.05);
      margin-top:10px;
    }
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .tag.good{color:var(--good); border-color:rgba(35,196,131,.25); background:rgba(35,196,131,.08)}
    .tag.bad{color:var(--bad); border-color:rgba(255,90,106,.25); background:rgba(255,90,106,.08)}
    .filters{display:grid; gap:10px}
    .frow{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width: 980px){ .frow{grid-template-columns:1fr} }
    label{display:block; font-size:11px; color:var(--muted); margin-bottom:6px}
    select, input[type="number"], input[type="date"]{
      width:100%;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
      font-size:13px;
    }
    .tableWrap{
      overflow:auto;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.06);
      background:rgba(0,0,0,.18);
    }
    table{width:100%; border-collapse:separate; border-spacing:0; min-width:900px}
    th,td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.06); vertical-align:top}
    th{
      position:sticky; top:0;
      background:rgba(10,15,20,.92);
      backdrop-filter: blur(6px);
      z-index:2;
      color:var(--muted);
      font-size:12px;
      text-align:left;
      font-weight:800;
      letter-spacing:.25px;
    }
    td{font-size:13px}
    tr:hover td{background:rgba(255,255,255,.02)}
    .mono{font-family:var(--mono); font-size:12px}
    .muted{color:var(--muted)}
    details.mini summary::-webkit-details-marker{display:none}
    details.mini summary{list-style:none}
    .note{font-size:12px; color:var(--muted); line-height:1.45}
    .rightCtl{display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:wrap}
    .pill .v.small{font-size:18px}
    .sep{height:1px; background:rgba(255,255,255,.06); margin:12px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>Win100 ‚Äî Live Scanner</h1>
        <div class="sub">UI Clean 100% ‚Ä¢ build <b id="uiBuild">clean-1</b></div>
      </div>
      <div class="tabs">
        <a class="tab" id="tabScanner" href="#scanner"><span class="dot"></span> Scanner</a>
        <a class="tab" id="tabDashboard" href="#dashboard">üìä Dashboard</a>
        <a class="tab" id="tabAI" href="#ai">üß† AI</a>
      </div>
    </div>

    <section id="secScanner">
      <div class="grid">
        <div class="panel">
          <div class="panelHead">
            <div>
              <div class="panelTitle">Controls</div>
              <div class="panelSub">Backend ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô (source of truth)</div>
            </div>
            <div class="btnRow">
              <button class="btn" id="btnScan">‚ñ∂ Scan</button>
              <button class="btn" id="btnSyncTop">‚úÖ Sync</button>
            </div>
          </div>

          <div class="filters">
            <div class="frow">
              <div>
                <label>Strategy</label>
                <select id="fStrategy">
                  <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                </select>
              </div>
              <div>
                <label>Market</label>
                <select id="fMarket">
                  <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                  <option value="HANDICAP">HANDICAP</option>
                  <option value="TOTAL">TOTAL</option>
                </select>
              </div>
            </div>

            <div class="frow">
              <div>
                <label>Min Edge</label>
                <input id="fMinEdge" type="number" step="0.0001" value="0" />
              </div>
              <div>
                <label>Min Kelly</label>
                <input id="fMinKelly" type="number" step="0.0001" value="0" />
              </div>
            </div>

            <div class="mini">
              <div class="pill"><div class="k">Fixtures</div><div id="mFixtures" class="v">0</div></div>
              <div class="pill"><div class="k">Signals</div><div id="mSignals" class="v">0</div></div>
              <div class="pill"><div class="k">Picks</div><div id="mPicks" class="v">0</div></div>
              <div class="pill"><div class="k">Tier A</div><div id="mA" class="v small">0</div></div>
              <div class="pill"><div class="k">Tier B</div><div id="mB" class="v small">0</div></div>
              <div class="pill"><div class="k">Tier C</div><div id="mC" class="v small">0</div></div>
            </div>

            <details class="mini" style="margin-top:10px">
              <summary style="cursor:pointer; user-select:none; color:var(--muted); font-size:12px">
                üìä Baseline ‡πÅ‡∏¢‡∏Å‡∏ï‡∏•‡∏≤‡∏î (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π)
              </summary>
              <div class="note" id="mFocus" style="margin-top:8px">HANDICAP: ‚Äî ‚Ä¢ TOTAL: ‚Äî</div>
            </details>

            <div class="statusLine">
              <span class="tag" id="tagStatus">‚Äî</span>
              <span id="miniStatus" class="muted">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πÅ‡∏Å‡∏ô</span>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panelHead">
            <div>
              <div class="panelTitle">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</div>
              <div class="panelSub">‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≤‡∏Å‡∏ú‡∏• /api/scan (picks)</div>
            </div>
            <div class="rightCtl">
              <span class="tag" id="tagCount">0 rows</span>
              <button class="btn" id="btnClear">üßπ Clear</button>
            </div>
          </div>

          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                  <th>‡∏•‡∏µ‡∏Å</th>
                  <th>‡∏Ñ‡∏π‡πà</th>
                  <th>Market</th>
                  <th>‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏∞‡πÑ‡∏£</th>
                  <th>Tier</th>
                  <th>Edge</th>
                  <th>Kelly</th>
                  <th>Stake</th>
                  <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</th>
                  <th>‡∏™‡∏Å‡∏≠‡∏£‡πå/‡∏ô‡∏≤‡∏ó‡∏µ</th>
                  <th class="mono">pickId</th>
                </tr>
              </thead>
              <tbody id="tbPicks">
                <tr><td colspan="12" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì ‚Äî ‡∏Å‡∏î Scan</td></tr>
              </tbody>
            </table>
          </div>

          <details class="mini" style="margin-top:12px" open>
            <summary style="cursor:pointer; user-select:none; color:var(--muted); font-size:12px">
              ‚è± Watchlist (Soft Signals) ‚Äî ‡∏à‡∏±‡∏ö‡∏ï‡∏≤‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà ‚Äú‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‚Äù (‡πÑ‡∏°‡πà log)
            </summary>
            <div class="tableWrap" style="margin-top:10px">
              <table style="min-width:860px">
                <thead>
                  <tr>
                    <th>‡∏Ñ‡∏π‡πà</th>
                    <th>‡∏™‡∏Å‡∏≠‡∏£‡πå/‡∏ô‡∏≤‡∏ó‡∏µ</th>
                    <th>‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ç‡πâ‡∏≤ (Top 2)</th>
                    <th>‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏≠‡∏¢‡∏π‡πà</th>
                    <th class="mono">fixtureId</th>
                  </tr>
                </thead>
                <tbody id="tbWatch">
                  <tr><td colspan="5" class="muted">‚Äî</td></tr>
                </tbody>
              </table>
            </div>
            <div class="note" style="margin-top:8px">
              * Watchlist ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å <span class="mono">/api/scan?debug=1</span> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡∏∏‡∏õ ‚Äú‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‚Äù (‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á pick, ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô log)
            </div>
          </details>

          <div class="note" style="margin-top:10px">
            * ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (Malay/SBOBET) ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô ‚Äú‚Äî‚Äù ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ odds feed (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ API-Football ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
          </div>
        </div>
      </div>
    </section>

    <section id="secDashboard" style="display:none">
      <div class="panel">
        <div class="panelHead">
          <div>
            <div class="panelTitle">Daily Summary (Baseline Performance)</div>
            <div class="panelSub" id="dashStatus">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô ‚Üí Refresh ‚Ä¢ ‡∏Å‡∏î Sync ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏ú‡∏•</div>
          </div>
          <div class="rightCtl">
            <input id="dashDate" type="date" />
            <button class="btn" id="btnDashRefresh">üîÅ Refresh</button>
            <button class="btn" id="btnDashSync">‚úÖ Sync Results</button>
          </div>
        </div>

        <div class="mini" style="margin-top:10px">
          <div class="pill"><div class="k">Bets</div><div id="dBets" class="v">0</div></div>
          <div class="pill"><div class="k">Pending</div><div id="dPending" class="v">0</div></div>
          <div class="pill"><div class="k">Win</div><div id="dWin" class="v">0</div></div>
          <div class="pill"><div class="k">Lose</div><div id="dLose" class="v">0</div></div>
          <div class="pill"><div class="k">Push</div><div id="dPush" class="v">0</div></div>
          <div class="pill"><div class="k">Profit</div><div id="dProfit" class="v">0</div></div>
        </div>

        <details class="mini" style="margin-top:10px" open>
          <summary style="cursor:pointer; user-select:none; color:var(--muted); font-size:12px">
            üìå ‡πÅ‡∏¢‡∏Å‡∏ï‡∏•‡∏≤‡∏î (HANDICAP vs TOTAL)
          </summary>
          <div class="mini" style="margin-top:10px">
            <div class="pill"><div class="k">HANDICAP ROI</div><div id="dRoiH" class="v small">0%</div></div>
            <div class="pill"><div class="k">HANDICAP Profit</div><div id="dProfitH" class="v small">0</div></div>
            <div class="pill"><div class="k">TOTAL ROI</div><div id="dRoiT" class="v small">0%</div></div>
            <div class="pill"><div class="k">TOTAL Profit</div><div id="dProfitT" class="v small">0</div></div>
            <div class="pill"><div class="k">Overall ROI</div><div id="dRoiAll" class="v small">0%</div></div>
            <div class="pill"><div class="k">Stake</div><div id="dStake" class="v small">0</div></div>
          </div>
        </details>

        <div class="sep"></div>

        <div class="panelHead" style="margin-bottom:8px">
          <div>
            <div class="panelTitle">Baseline per Strategy (Market + Strategy)</div>
            <div class="panelSub">‡πÉ‡∏ä‡πâ‡∏ú‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å logs (picks/results)</div>
          </div>
        </div>

        <div class="tableWrap">
          <table style="min-width:780px">
            <thead>
              <tr>
                <th>Market</th>
                <th>Strategy</th>
                <th>Bets</th>
                <th>W</th>
                <th>L</th>
                <th>P</th>
                <th>WinRate</th>
                <th>Profit</th>
                <th>Stake</th>
                <th>ROI</th>
              </tr>
            </thead>
            <tbody id="tbBaseline">
              <tr><td colspan="10" class="muted">‚Äî</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="secAI" style="display:none">
      <div class="panel">
        <div class="panelHead">
          <div>
            <div class="panelTitle">AI / Optimizer</div>
            <div class="panelSub">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å OpenAI ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (placeholder)</div>
          </div>
        </div>
        <div class="note">
          ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° OpenAI: ‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô endpoint ‡πÄ‡∏™‡∏£‡∏¥‡∏° ‡πÄ‡∏ä‡πà‡∏ô /api/explain/pick, /api/optimizer/suggest ‡πÇ‡∏î‡∏¢ backend ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
        </div>
      </div>
    </section>
  </div>

<script>
  "use strict";
  function el(id){ return document.getElementById(id); }
  function cleanText(v){
    const s = (v==null ? "" : String(v));
    if(s.includes("${")) return "";
    return s.trim();
  }
  function cleanTeam(v){ return cleanText(v) || "-"; }
  function fmtNum(x, d=2){
    const n = Number(x);
    if(!Number.isFinite(n)) return "‚Äî";
    return n.toFixed(d);
  }
  function pct(x, d=2){
    const n = Number(x);
    if(!Number.isFinite(n)) return "0%";
    return (n*100).toFixed(d) + "%";
  }
  async function fetchJsonOrThrow(url, opts){
    const r = await fetch(url, opts);
    const ct = (r.headers.get("content-type")||"").toLowerCase();
    if(ct.includes("application/json")){
      const data = await r.json();
      return { r, data };
    }
    const t = await r.text();
    const head = t.slice(0, 220).replace(/\s+/g," ").trim();
    throw new Error("‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON: " + head);
  }
  function setActiveTab(which){
    const tabScanner = el("tabScanner");
    const tabDashboard = el("tabDashboard");
    const tabAI = el("tabAI");
    [tabScanner, tabDashboard, tabAI].filter(Boolean).forEach(t => t.classList.remove("active"));
    if(which==="scanner" && tabScanner) tabScanner.classList.add("active");
    if(which==="dashboard" && tabDashboard) tabDashboard.classList.add("active");
    if(which==="ai" && tabAI) tabAI.classList.add("active");
  }
  function show(which){
    const secScanner = el("secScanner");
    const secDashboard = el("secDashboard");
    const secAI = el("secAI");
    if(secScanner) secScanner.style.display = (which==="scanner") ? "" : "none";
    if(secDashboard) secDashboard.style.display = (which==="dashboard") ? "" : "none";
    if(secAI) secAI.style.display = (which==="ai") ? "" : "none";
    setActiveTab(which);
  }

  let lastPicks = [];
  let lastMeta = {};
  let strategySet = new Set();

  const btnScan = el("btnScan");
  const btnClear = el("btnClear");
  const btnSyncTop = el("btnSyncTop");
  const fStrategy = el("fStrategy");
  const fMarket = el("fMarket");
  const fMinEdge = el("fMinEdge");
  const fMinKelly = el("fMinKelly");
  const tbPicks = el("tbPicks");
  const tbWatch = el("tbWatch");
  const mFixtures = el("mFixtures");
  const mSignals = el("mSignals");
  const mPicks = el("mPicks");
  const mA = el("mA"), mB = el("mB"), mC = el("mC");
  const tagStatus = el("tagStatus");
  const miniStatus = el("miniStatus");
  const tagCount = el("tagCount");
  const mFocus = el("mFocus");

  const dashDate = el("dashDate");
  const btnDashRefresh = el("btnDashRefresh");
  const btnDashSync = el("btnDashSync");
  const dashStatus = el("dashStatus");
  const dBets = el("dBets"), dPending = el("dPending"), dWin = el("dWin"), dLose = el("dLose"), dPush = el("dPush"), dProfit = el("dProfit");
  const dStake = el("dStake"), dRoiAll = el("dRoiAll");
  const dRoiH = el("dRoiH"), dProfitH = el("dProfitH"), dRoiT = el("dRoiT"), dProfitT = el("dProfitT");
  const tbBaseline = el("tbBaseline");

  function route(){
    const h = (location.hash || "#scanner").toLowerCase();
    if(h.includes("dashboard")){ show("dashboard"); loadDailySummary().catch(()=>{}); }
    else if(h.includes("ai")){ show("ai"); }
    else { show("scanner"); }
  }
  window.addEventListener("hashchange", route);

  (function initDate(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    if(dashDate) dashDate.value = y + "-" + m + "-" + da;
  })();

  function buildPlayText(p){
    const market = cleanText(p.market) || "-";
    const selection = cleanText(p.selection) || cleanText(p.side) || cleanText(p.betType) || "";
    const line = (p.line!=null ? p.line : p.handicap!=null ? p.handicap : p.totalLine!=null ? p.totalLine : null);
    const lineTxt = (line==null || line==="") ? "" : String(line);
    if(market==="HANDICAP"){
      let who = selection || cleanText(p.team) || "";
      if(!who){
        if(p.side==="home") who = cleanTeam(p.home);
        else if(p.side==="away") who = cleanTeam(p.away);
      }
      return (who || "-") + " " + (lineTxt || "");
    }
    if(market==="TOTAL"){
      const ou = selection || "";
      const s = ou ? ou.toUpperCase() : "-";
      return s + " " + (lineTxt || "");
    }
    return (market + " " + selection + " " + lineTxt).trim();
  }

  function leagueText(p){
    if(typeof p.league === "string") return cleanText(p.league) || "-";
    if(p.league && typeof p.league === "object" && p.league.name) return cleanText(p.league.name) || "-";
    return cleanText(p.leagueName) || cleanText(p.league_name) || "-";
  }
  function edgeText(p){
    const e = (p.edge!=null ? Number(p.edge) : (p.metrics && p.metrics.edge!=null ? Number(p.metrics.edge) : NaN));
    return Number.isFinite(e) ? e.toFixed(4) : "‚Äî";
  }
  function kellyText(p){
    const k = (p.kelly!=null ? Number(p.kelly) : (p.metrics && p.metrics.kelly!=null ? Number(p.metrics.kelly) : NaN));
    return Number.isFinite(k) ? k.toFixed(4) : "‚Äî";
  }
  function stakeText(p){
    const s = (p.stake!=null ? p.stake : p.stakeUnit!=null ? p.stakeUnit : null);
    return (s==null ? "‚Äî" : String(s));
  }
  function priceText(p){
    const v = (p.priceTaken!=null ? p.priceTaken :
              p.price!=null ? p.price :
              p.odds!=null ? p.odds :
              p.oddsDecimal!=null ? p.oddsDecimal :
              null);
    return (v==null ? "‚Äî" : String(v));
  }
  function scoreMinuteText(p){
    const scoreText = (p.scoreAtScan!=null) ? String(p.scoreAtScan)
      : (p.scoreHome!=null || p.scoreAway!=null) ? (String(p.scoreHome ?? "-") + "-" + String(p.scoreAway ?? "-"))
      : (p.score && typeof p.score==="object" && (p.score.home!=null || p.score.away!=null)) ? (String(p.score.home ?? "-") + "-" + String(p.score.away ?? "-"))
      : null;

    const minuteText = (p.minuteAtScan!=null) ? String(p.minuteAtScan)
      : (p.minute!=null) ? String(p.minute)
      : (p.elapsed!=null) ? String(p.elapsed)
      : (p.time && typeof p.time==="object" && p.time.elapsed!=null) ? String(p.time.elapsed)
      : null;

    if(scoreText==null && minuteText==null) return "-";
    return (scoreText!=null?scoreText:"-") + " / " + (minuteText!=null?minuteText:"-") + "'";
  }

  // ===== Watchlist (Soft Signals) =====
  function normalizeReason(r){
    const s = cleanText(r);
    if(!s) return "";
    // Ignore placeholder builder warnings (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç)
    if(s.toLowerCase().includes("builder not included")) return "";
    return s;
  }

  function buildWatchRows(debug){
    if(!debug || !Array.isArray(debug.rejected)) return [];
    const rows = [];
    for(const fx of debug.rejected){
      const fixtureId = fx.fixtureId;
      const home = cleanTeam(fx.home);
      const away = cleanTeam(fx.away);
      const minute = fx.minute != null ? String(fx.minute) : "-";
      const score = cleanText(fx.score) || "-";
      const strategies = Array.isArray(fx.rejected) ? fx.rejected : [];

      // Score closeness: fewer real reasons => closer
      const scored = strategies.map(st => {
        const reasons = Array.isArray(st.reasons) ? st.reasons.map(normalizeReason).filter(Boolean) : [];
        return {
          strategy: cleanText(st.strategy) || "-",
          label: cleanText(st.label) || cleanText(st.strategy) || "-",
          reasons,
          reasonCount: reasons.length
        };
      });

      // Prefer strategies that have explicit reasons (we can show what's missing)
      // Sort: reasonCount asc, but push "no reasons" to the end because it's usually "no trigger" (not actionable)
      scored.sort((a,b)=>{
        const ax = (a.reasonCount===0 ? 999 : a.reasonCount);
        const bx = (b.reasonCount===0 ? 999 : b.reasonCount);
        return ax - bx;
      });

      const top = scored.slice(0,2);
      // If top strategies are actually "no trigger" only, still show them but mark accordingly
      const topText = top.map(t => t.label).join(" ‚Ä¢ ") || "-";

      const missing = top
        .flatMap(t => t.reasons.length ? t.reasons : [`${t.label}: (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ trigger/‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á)`])
        .slice(0,4);

      rows.push({
        fixtureId,
        match: `${home} vs ${away}`,
        scoreMin: `${score} / ${minute}'`,
        topText,
        missingText: missing.join(" | ") || "-",
        closeness: Math.min(...top.map(t => (t.reasonCount===0 ? 999 : t.reasonCount)), 999)
      });
    }
    // Sort by closeness then fixtureId
    rows.sort((a,b)=> a.closeness - b.closeness || (a.fixtureId||0)-(b.fixtureId||0));
    return rows;
  }

  function renderWatchlist(debug){
    if(!tbWatch) return;
    const rows = buildWatchRows(debug);
    if(!rows.length){
      tbWatch.innerHTML = '<tr><td colspan="5" class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ watchlist (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ live ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ debug)</td></tr>';
      return;
    }
    // limit rows
    const lim = rows.slice(0, 12);
    tbWatch.innerHTML = "";
    for(const r of lim){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><b>${r.match}</b></td>
        <td class="mono">${r.scoreMin}</td>
        <td>${r.topText}</td>
        <td class="muted">${r.missingText}</td>
        <td class="mono">${r.fixtureId ?? "-"}</td>
      `;
      tbWatch.appendChild(tr);
    }
  }

  function applyFilters(rows){
    const sKey = (fStrategy && fStrategy.value) ? fStrategy.value : "";
    const mkt = (fMarket && fMarket.value) ? fMarket.value : "";
    const minEdge = (fMinEdge && fMinEdge.value!=="") ? Number(fMinEdge.value) : 0;
    const minKelly = (fMinKelly && fMinKelly.value!=="") ? Number(fMinKelly.value) : 0;

    return rows.filter(p=>{
      if(sKey && cleanText(p.strategy) !== sKey) return false;
      if(mkt && cleanText(p.market) !== mkt) return false;
      const e = (p.edge!=null ? Number(p.edge) : NaN);
      const k = (p.kelly!=null ? Number(p.kelly) : NaN);
      if(Number.isFinite(minEdge) && minEdge>0 && !(Number.isFinite(e) && e>=minEdge)) return false;
      if(Number.isFinite(minKelly) && minKelly>0 && !(Number.isFinite(k) && k>=minKelly)) return false;
      return true;
    });
  }

  function renderPicks(){
    if(!tbPicks) return;
    const rows = applyFilters(lastPicks);
    if(tagCount) tagCount.textContent = rows.length + " rows";

    if(!rows.length){
      const fx = lastMeta._totalFixtures ?? lastMeta.fixtures ?? 0;
      const msgEl = document.getElementById("noPickMsg");
      if(msgEl){
        msgEl.innerHTML = `‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡πâ‡∏ß <b>${fx}</b> ‡∏Ñ‡∏π‡πà LIVE<br>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏™‡∏π‡∏ï‡∏£`;
      }
      tbPicks.innerHTML = '<tr><td colspan="12" class="muted"><span id="noPickMsg"></span></td></tr>';
      return;
    }
    tbPicks.innerHTML = "";
    for(const p of rows){
      const ts = cleanText(p.ts) || cleanText(p.time) || "";
      const timeTxt = ts ? ts : "‚Äî";
      const league = leagueText(p);
      const match = cleanTeam(p.home) + " vs " + cleanTeam(p.away);
      const market = cleanText(p.market) || "‚Äî";
      const play = buildPlayText(p);
      const tier = cleanText(p.tier) || "‚Äî";
      const edge = edgeText(p);
      const kelly = kellyText(p);
      const stake = stakeText(p);
      const price = priceText(p);
      const scoreMin = scoreMinuteText(p);
      const pickId = cleanText(p.pickId) || "‚Äî";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${timeTxt}</td>
        <td>${league}</td>
        <td><b>${match}</b></td>
        <td><span class="tag">${market}</span></td>
        <td>${play}</td>
        <td><span class="tag">${tier}</span></td>
        <td class="mono">${edge}</td>
        <td class="mono">${kelly}</td>
        <td class="mono">${stake}</td>
        <td class="mono">${price}</td>
        <td class="mono">${scoreMin}</td>
        <td class="mono">${pickId}</td>
      `;
      tbPicks.appendChild(tr);
    }
  }

  function updateStrategyOptions(picks){
    if(!fStrategy) return;
    let changed = false;
    for(const p of picks){
      const k = cleanText(p.strategy);
      if(k && !strategySet.has(k)){
        strategySet.add(k);
        changed = true;
      }
    }
    if(!changed) return;
    const cur = fStrategy.value || "";
    const keys = Array.from(strategySet).sort();
    fStrategy.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>' + keys.map(k=>`<option value="${k}">${k}</option>`).join("");
    fStrategy.value = cur;
  }

  function setStatus(ok, msg){
    if(tagStatus){
      tagStatus.className = "tag " + (ok ? "good" : "bad");
      tagStatus.textContent = ok ? "OK" : "ERROR";
    }
    if(miniStatus) miniStatus.textContent = msg || "‚Äî";
  }

  function setScanMetrics(meta, picks){
    const fixtures = Number(meta.fixtures || meta.fixtureCount || meta.totalFixtures || 0) || 0;
    const signals = Number(meta.signals || meta.signalCount || meta.totalSignals || 0) || 0;
    const totalPicks = picks.length;

    if(mFixtures) mFixtures.textContent = String(fixtures);
    if(mSignals) mSignals.textContent = String(signals);
    if(mPicks) mPicks.textContent = String(totalPicks);

    let a=0,b=0,c=0;
    for(const p of picks){
      const t = cleanText(p.tier).toUpperCase();
      if(t==="A") a++;
      else if(t==="B") b++;
      else if(t==="C") c++;
    }
    if(mA) mA.textContent = String(a);
    if(mB) mB.textContent = String(b);
    if(mC) mC.textContent = String(c);

    if(mFocus){
      const h = meta.focus && meta.focus.HANDICAP ? meta.focus.HANDICAP : null;
      const t = meta.focus && meta.focus.TOTAL ? meta.focus.TOTAL : null;
      if(h || t){
        const ht = h ? ("HANDICAP: ROI " + pct(h.roi||0,2) + " ‚Ä¢ P/L " + fmtNum(h.profit||0,2)) : "HANDICAP: ‚Äî";
        const tt = t ? ("TOTAL: ROI " + pct(t.roi||0,2) + " ‚Ä¢ P/L " + fmtNum(t.profit||0,2)) : "TOTAL: ‚Äî";
        mFocus.textContent = ht + " ‚Ä¢ " + tt;
      }
    }
  }

  async function doScan(){
    try{
      if(btnScan) btnScan.disabled = true;
      setStatus(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô‚Ä¶");
      const { data } = await fetchJsonOrThrow("/api/scan?debug=1", { method:"POST", headers:{ "Content-Type":"application/json" }, body:"{}" });
      const ok = (data && (data.status==="success" || data.ok===true || Array.isArray(data.picks)));
      if(!ok) throw new Error(data.message || data.error || "‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

      const picks = Array.isArray(data.picks) ? data.picks : [];
      lastPicks = picks;
      lastMeta = data.meta || data.stats || {};
      lastMeta._totalFixtures = data.totalFixtures ?? lastMeta.fixtures ?? 0;
      updateStrategyOptions(picks);
      setScanMetrics(lastMeta, picks);

      if(picks.length===0){
        setStatus(true, `‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏û‡∏ö ${lastMeta._totalFixtures ?? 0} ‡∏Ñ‡∏π‡πà LIVE ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏™‡∏π‡∏ï‡∏£`);
      }else{
        setStatus(true, `‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${picks.length} ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì`);
      }
      renderPicks();
      renderWatchlist(data.debug);
    }catch(e){
      console.error(e);
      setStatus(false, String(e.message || e));
      if(tbPicks) tbPicks.innerHTML = '<tr><td colspan="12" class="muted">‡∏™‡πÅ‡∏Å‡∏ô‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + String(e.message||e) + '</td></tr>';
    }finally{
      if(btnScan) btnScan.disabled = false;
    }
  }

  async function doSync(where){
    const btn = (where==="dash") ? btnDashSync : btnSyncTop;
    try{
      if(btn) btn.disabled = true;
      if(where==="dash" && dashStatus) dashStatus.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á Sync results‚Ä¶";
      if(where!=="dash") setStatus(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á Sync results‚Ä¶");

      const { data } = await fetchJsonOrThrow("/api/results/sync", { method:"POST", headers:{ "Content-Type":"application/json" }, body:"{}" });
      const ok = (data && (data.status==="success" || data.ok===true));
      if(!ok) throw new Error(data.message || data.error || "Sync ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

      const msg = "Sync ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Ä¢ checked " + (data.checkedPending ?? "-") + " ‚Ä¢ settled " + (data.settled ?? "-") + " ‚Ä¢ skipped " + (data.skipped ?? "-");
      if(where==="dash" && dashStatus) dashStatus.textContent = msg;
      if(where!=="dash") setStatus(true, msg);

      if(location.hash.toLowerCase().includes("dashboard")){
        await loadDailySummary();
      }
    }catch(e){
      console.error(e);
      const msg = "Sync error: " + String(e.message || e);
      if(where==="dash" && dashStatus) dashStatus.textContent = msg;
      if(where!=="dash") setStatus(false, msg);
    }finally{
      if(btn) btn.disabled = false;
    }
  }

  function clearPicks(){
    lastPicks = [];
    renderPicks();
    if(mPicks) mPicks.textContent = "0";
    if(tagCount) tagCount.textContent = "0 rows";
    setStatus(true, "‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß");
    if(tbWatch) tbWatch.innerHTML = '<tr><td colspan="5" class="muted">‚Äî</td></tr>';
  }

  function setDashStatus(msg){
    if(dashStatus) dashStatus.textContent = msg;
  }

  async function loadDailySummary(){
    try{
      const date = dashDate ? dashDate.value : "";
      if(!date) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà");
      setDashStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‚Ä¶");
      const { data } = await fetchJsonOrThrow("/api/summary/day?date=" + encodeURIComponent(date), { method:"GET" });

      const ok = data && (data.status==="success" || data.ok===true || data.overall);
      if(!ok) throw new Error(data.message || data.error || "‡πÇ‡∏´‡∏•‡∏î summary ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

      const overall = data.overall || data.summary || {};
      const bets = Number(overall.bets || overall.total || 0) || 0;
      const pending = Number(overall.pending || 0) || 0;
      const win = Number(overall.win || overall.wins || 0) || 0;
      const lose = Number(overall.lose || overall.losses || 0) || 0;
      const push = Number(overall.push || overall.pushes || 0) || 0;
      const profit = Number(overall.profit || 0) || 0;
      const stake = Number(overall.stake || 0) || 0;
      const roi = stake>0 ? (profit/stake) : 0;

      if(dBets) dBets.textContent = String(bets);
      if(dPending) dPending.textContent = String(pending);
      if(dWin) dWin.textContent = String(win);
      if(dLose) dLose.textContent = String(lose);
      if(dPush) dPush.textContent = String(push);
      if(dProfit) dProfit.textContent = fmtNum(profit, 2);

      if(dStake) dStake.textContent = fmtNum(stake, 2);
      if(dRoiAll) dRoiAll.textContent = pct(roi, 2);

      const focus = data.focus || data.markets || {};
      const h = focus.HANDICAP || focus.handicap || null;
      const t = focus.TOTAL || focus.total || null;

      const hProfit = h ? Number(h.profit||0) : 0;
      const hStake = h ? Number(h.stake||0) : 0;
      const tProfit = t ? Number(t.profit||0) : 0;
      const tStake = t ? Number(t.stake||0) : 0;

      if(dProfitH) dProfitH.textContent = fmtNum(hProfit,2);
      if(dRoiH) dRoiH.textContent = pct(hStake>0 ? hProfit/hStake : 0, 2);
      if(dProfitT) dProfitT.textContent = fmtNum(tProfit,2);
      if(dRoiT) dRoiT.textContent = pct(tStake>0 ? tProfit/tStake : 0, 2);

      const rows = Array.isArray(data.marketStrategies) ? data.marketStrategies
                : Array.isArray(data.rows) ? data.rows
                : [];

      if(tbBaseline){
        if(!rows.length){
      const fx = lastMeta._totalFixtures ?? lastMeta.fixtures ?? 0;
      const msgEl = document.getElementById("noPickMsg");
      if(msgEl){
        msgEl.innerHTML = `‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡πâ‡∏ß <b>${fx}</b> ‡∏Ñ‡∏π‡πà LIVE<br>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏™‡∏π‡∏ï‡∏£`;
      }
          tbBaseline.innerHTML = '<tr><td colspan="10" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏ó‡∏µ‡πà settle ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏Å‡∏î Sync ‡∏Å‡πà‡∏≠‡∏ô)</td></tr>';
        }else{
          tbBaseline.innerHTML = "";
          for(const r of rows){
            const market = cleanText(r.market) || "‚Äî";
            const strategy = cleanText(r.strategy) || "‚Äî";
            const betsR = Number(r.bets||0) || 0;
            const w = Number(r.wins||r.win||0) || 0;
            const l = Number(r.losses||r.lose||0) || 0;
            const p = Number(r.pushes||r.push||0) || 0;
            const stakeR = Number(r.stakeSum||r.stake||0) || 0;
            const profR = Number(r.profitSum||r.profit||0) || 0;
            const roiR = stakeR>0 ? profR/stakeR : 0;
            const winRate = (w+l+p)>0 ? (w/(w+l+p)) : 0;

            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td><span class="tag">${market}</span></td>
              <td><span class="tag">${strategy}</span></td>
              <td class="mono">${betsR}</td>
              <td class="mono">${w}</td>
              <td class="mono">${l}</td>
              <td class="mono">${p}</td>
              <td class="mono">${pct(winRate,1)}</td>
              <td class="mono">${fmtNum(profR,2)}</td>
              <td class="mono">${fmtNum(stakeR,2)}</td>
              <td class="mono">${pct(roiR,2)}</td>
            `;
            tbBaseline.appendChild(tr);
          }
        }
      }
      setDashStatus("‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + date);
    }catch(e){
      console.error(e);
      setDashStatus("‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + String(e.message || e));
      if(tbBaseline) tbBaseline.innerHTML = '<tr><td colspan="10" class="muted">‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + String(e.message||e) + '</td></tr>';
    }
  }

  if(btnScan) btnScan.addEventListener("click", ()=>doScan());
  if(btnClear) btnClear.addEventListener("click", ()=>clearPicks());
  if(btnSyncTop) btnSyncTop.addEventListener("click", ()=>doSync("top"));
  if(fStrategy) fStrategy.addEventListener("change", ()=>renderPicks());
  if(fMarket) fMarket.addEventListener("change", ()=>renderPicks());
  if(fMinEdge) fMinEdge.addEventListener("input", ()=>renderPicks());
  if(fMinKelly) fMinKelly.addEventListener("input", ()=>renderPicks());

  if(btnDashRefresh) btnDashRefresh.addEventListener("click", ()=>loadDailySummary());
  if(btnDashSync) btnDashSync.addEventListener("click", ()=>doSync("dash"));
  if(dashDate) dashDate.addEventListener("change", ()=>loadDailySummary());

  route();
</script>
</body>
</html>
