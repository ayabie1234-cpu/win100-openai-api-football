<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>üß† AI Optimizer ‚Äì Win100 (EV-aware)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{background:#020617;color:#e5e7eb;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif}
    .card{background:rgba(15,23,42,.95);border-radius:.75rem;border:1px solid rgba(148,163,184,.4)}
    .pill{padding:.2rem .6rem;border-radius:999px;font-size:.72rem;font-weight:700;display:inline-flex}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .k{color:#a5b4fc}
    .v{color:#86efac}
    .chg{color:#fca5a5}
  </style>
</head>
<body class="min-h-screen">
  <!-- ‡πÄ‡∏°‡∏ô‡∏π -->
  <header class="w-full border-b border-slate-800 bg-slate-900/80 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-wrap items-center justify-between gap-3">
      <div class="flex items-center gap-2">
        <span class="text-2xl">‚öΩ</span>
        <div>
          <div class="text-sm font-semibold text-emerald-400">Win100 ‚Äì AI Optimizer (EV/ROI/CLV)</div>
          <div class="text-[11px] text-slate-400">‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≠‡∏•‡∏™‡∏î | ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ | ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏π‡∏ï‡∏£‡∏î‡πâ‡∏ß‡∏¢ AI</div>
        </div>
      </div>
      <nav class="flex flex-wrap gap-2 text-xs">
        <a href="/" class="px-3 py-1.5 rounded-full border border-slate-600 bg-slate-800 hover:bg-emerald-500 hover:text-slate-900 transition">üü¢ ‡∏´‡∏ô‡πâ‡∏≤ Scanner ‡∏™‡∏î</a>
        <a href="/dashboard.html" class="px-3 py-1.5 rounded-full border border-slate-600 bg-slate-800 hover:bg-sky-500 hover:text-slate-900 transition">üìä Dashboard ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</a>
        <a href="/ai_optimizer.html" class="px-3 py-1.5 rounded-full border border-slate-600 bg-slate-800 hover:bg-violet-500 hover:text-slate-900 transition">üß† AI Optimizer</a>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <!-- ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° -->
    <div class="card p-4">
      <div class="flex flex-wrap items-center gap-3">
        <div class="text-sm text-slate-200">‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏ô‡πâ‡∏ô WinRate/ROI/CLV ‡∏î‡∏µ ‚Üí ‡∏Ñ‡∏•‡∏≤‡∏¢‡∏™‡∏π‡∏ï‡∏£, ‡∏≠‡πà‡∏≠‡∏ô ‚Üí ‡πÄ‡∏Ç‡πâ‡∏°/‡∏õ‡∏¥‡∏î)</div>
        <div class="ml-auto flex gap-2">
          <button id="btnOptimize" class="px-4 py-2 rounded-lg bg-violet-500 hover:bg-violet-400 text-slate-900 text-sm font-semibold">ü§ñ ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI</button>
          <button id="btnApply" class="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-slate-900 text-sm font-semibold" disabled>‚úÖ Apply ‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</button>
        </div>
      </div>
      <div id="status" class="text-xs text-slate-400 mt-2"></div>
    </div>

    <!-- ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° EV ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -->
    <div class="card p-4">
      <h2 class="text-sm font-semibold text-slate-100 mb-3">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏™‡∏π‡∏ï‡∏£ (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</h2>
      <div id="evSummary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 text-xs"></div>
    </div>

    <!-- ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å AI -->
    <div class="card p-4">
      <h2 class="text-sm font-semibold text-slate-100 mb-3">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏à‡∏≤‡∏Å AI</h2>
      <ul id="aiNotes" class="list-disc pl-5 text-xs text-slate-300 space-y-1"></ul>
      <div id="noNotes" class="text-xs text-slate-400">‚Äî ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠ ‚Äî</div>
    </div>

    <!-- Diff ‡πÅ‡∏ö‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ -->
    <div class="card p-4">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-sm font-semibold text-slate-100">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡πà‡∏≤ params ‡∏ó‡∏µ‡πà AI ‡πÄ‡∏™‡∏ô‡∏≠ (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö current ‚Üí suggest)</h2>
        <label class="text-xs text-slate-400 flex items-center gap-2">
          <input id="toggleOnlyChanged" type="checkbox" class="accent-emerald-500" checked>
          ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
        </label>
      </div>
      <div id="diffWrap" class="mono text-xs overflow-x-auto whitespace-pre border border-slate-700/70 rounded-lg p-3 bg-slate-900/60">‚Äî</div>
    </div>

    <!-- JSON ‡∏î‡∏¥‡∏ö (‡∏´‡∏≤‡∏Å‡∏≠‡∏¢‡∏≤‡∏Å‡πÅ‡∏Å‡πâ‡∏°‡∏∑‡∏≠) -->
    <div class="card p-4">
      <h2 class="text-sm font-semibold text-slate-100 mb-2">JSON ‡∏ó‡∏µ‡πà AI ‡∏™‡πà‡∏á‡∏°‡∏≤ (‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏Å‡πà‡∏≠‡∏ô Apply)</h2>
      <textarea id="jsonBox" class="mono w-full min-h-[220px] bg-slate-950 border border-slate-700 rounded-lg p-3 text-xs" spellcheck="false" placeholder='{"strategies": {...}, "notes":[...]}'></textarea>
      <div class="flex justify-end mt-2">
        <button id="btnValidate" class="px-3 py-1.5 rounded-md bg-sky-500 hover:bg-sky-400 text-slate-900 text-xs font-semibold">üîé ‡∏ï‡∏£‡∏ß‡∏à JSON</button>
      </div>
    </div>
  </main>

  <script>
    const btnOptimize = document.getElementById("btnOptimize");
    const btnApply = document.getElementById("btnApply");
    const btnValidate = document.getElementById("btnValidate");
    const statusBox = document.getElementById("status");
    const evSummary = document.getElementById("evSummary");
    const aiNotes = document.getElementById("aiNotes");
    const noNotes = document.getElementById("noNotes");
    const jsonBox = document.getElementById("jsonBox");
    const diffWrap = document.getElementById("diffWrap");
    const toggleOnlyChanged = document.getElementById("toggleOnlyChanged");

    let lastSuggestions = null;
    let currentStats = null;

    function setStatus(msg){ statusBox.textContent = msg || ""; }
    function fmt(x, d=2){ return (x===null || x===undefined || isNaN(x))? "‚Äì" : Number(x).toFixed(d); }
    function wr(win, lose){ const t = (win||0)+(lose||0); return t? Math.round((win||0)*100/t):0; }

    async function loadStats(){
      // ‡∏Ç‡∏≠ overall ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥ byStrategy ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á EV ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      try{
        const r = await fetch("/api/stats");
        const data = await r.json();
        if(data.status!=="success") throw new Error(data.message||"‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        currentStats = data;
        renderEVSummary(data.byStrategy||{});
      }catch(e){
        console.error(e);
        evSummary.innerHTML = '<div class="text-xs text-slate-400">‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ß‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>';
      }
    }

    function renderEVSummary(byStrategy){
      evSummary.innerHTML = "";
      const keys = Object.keys(byStrategy).sort();
      if(!keys.length){
        evSummary.innerHTML = '<div class="text-xs text-slate-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
        return;
      }
      for(const key of keys){
        const s = byStrategy[key];
        const card = document.createElement("div");
        card.className = "border border-slate-700 rounded-lg px-3 py-2 bg-slate-900/60";
        card.innerHTML = `
          <div class="font-semibold text-sky-300 mb-1">${key}</div>
          <div class="grid grid-cols-2 gap-1 text-[11px] text-slate-300">
            <div>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${s.total||0}</div>
            <div>WinRate: ${wr(s.win||0, s.lose||0)}%</div>
            <div>ROI/‡∏ö‡∏¥‡∏•: ${fmt(s.roiAvg,4)}</div>
            <div>CLV ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${s.clvAvg===null?"‚Äì":fmt(s.clvAvg,2)+"%"}</div>
          </div>`;
        evSummary.appendChild(card);
      }
    }

    function renderNotes(notes){
      aiNotes.innerHTML = "";
      if(!Array.isArray(notes) || !notes.length){
        noNotes.style.display = "block";
        return;
      }
      noNotes.style.display = "none";
      for(const n of notes){
        const li = document.createElement("li");
        li.textContent = n;
        aiNotes.appendChild(li);
      }
    }

    function diffStrategies(current, suggest, onlyChanged=true){
      const out = [];
      const allKeys = new Set([...Object.keys(current||{}), ...Object.keys(suggest||{})]);
      for(const k of [...allKeys].sort()){
        const cur = current?.[k] || {};
        const sug = suggest?.[k] || {};
        const changed = [];

        // enabled
        if(cur.enabled !== sug.enabled){
          changed.push(`  .enabled: ${cur.enabled}  ‚Üí  ${sug.enabled}`);
        }

        // label (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
        if(cur.label !== sug.label && sug.label){
          changed.push(`  .label: "${cur.label||""}"  ‚Üí  "${sug.label}"`);
        }

        // params
        const pKeys = new Set([...Object.keys(cur.params||{}), ...Object.keys(sug.params||{})]);
        for(const pk of [...pKeys].sort()){
          const a = cur.params?.[pk];
          const b = sug.params?.[pk];
          if (a !== b) changed.push(`  .params.${pk}: ${String(a)}  ‚Üí  ${String(b)}`);
        }

        if(!onlyChanged){
          out.push(`${k}:\n${changed.length? changed.map(x=>"‚Ä¢ "+x).join("\n"):"  (no change)"}`);
        }else if(changed.length){
          out.push(`${k}:\n${changed.map(x=>"‚Ä¢ "+x).join("\n")}`);
        }
      }
      return out.join("\n\n") || "‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á ‚Äî";
    }

    async function doOptimize(){
      setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI‚Ä¶");
      btnOptimize.disabled = true;
      btnApply.disabled = true;
      try{
        const r = await fetch("/api/ai-optimize", { method: "POST", headers: { "Content-Type":"application/json" }, body: JSON.stringify({}) });
        const data = await r.json();
        if(data.status!=="success") throw new Error(data.message||"‡πÄ‡∏£‡∏µ‡∏¢‡∏Å AI ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

        lastSuggestions = data.suggestions || {};
        // ‡πÉ‡∏™‡πà JSON ‡∏•‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡∏°‡∏∑‡∏≠‡πÑ‡∏î‡πâ
        jsonBox.value = JSON.stringify(lastSuggestions, null, 2);

        // render notes
        renderNotes(lastSuggestions.notes || []);

        // diff current vs suggest
        const text = diffStrategies(data.currentStrategies||{}, (lastSuggestions.strategies||{}), toggleOnlyChanged.checked);
        diffWrap.textContent = text;

        setStatus("‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏à‡∏≤‡∏Å AI ‡πÅ‡∏•‡πâ‡∏ß");
        btnApply.disabled = !lastSuggestions?.strategies;
      }catch(e){
        console.error(e);
        setStatus("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: "+e.message);
      }finally{
        btnOptimize.disabled = false;
      }
    }

    async function doApply(){
      try{
        const parsed = JSON.parse(jsonBox.value || "{}");
        if(!parsed || typeof parsed!=="object" || !parsed.strategies){
          alert("JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ field strategies");
          return;
        }
        setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á Apply ‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‚Ä¶");
        btnApply.disabled = true;

        const r = await fetch("/api/apply-strategies", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ strategies: parsed.strategies })
        });
        const data = await r.json();
        if(data.status!=="success") throw new Error(data.message||"Apply ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

        setStatus("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï strategies ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
        // ‡∏´‡∏•‡∏±‡∏á Apply ‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ú‡∏•)
        loadStats();
      }catch(e){
        console.error(e);
        setStatus("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≠‡∏ô Apply: "+e.message);
      }
    }

    function validateJSON(){
      try{
        const o = JSON.parse(jsonBox.value||"");
        alert("‚úÖ JSON ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï diff ‡∏ï‡∏≤‡∏° JSON ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö current ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        if(currentStats){
          // ‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ currentStrategies ‡πÉ‡∏ô endpoint /api/stats; ‡∏á‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å optimize ‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á currentStrategies ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
          // ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        }
      }catch(e){
        alert("‚ùå JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: "+e.message);
      }
    }

    toggleOnlyChanged.addEventListener("change", ()=>{
      try{
        const cur = (window.__lastCurrent || null);
        // ‡πÄ‡∏£‡∏≤‡πÄ‡∏Å‡πá‡∏ö currentStrategies ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö /api/ai-optimize ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å ‡∏à‡∏∞ reuse ‡∏à‡∏≤‡∏Å last call
      }catch{}
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å optimize ‡∏ã‡πâ‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä diff ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢
      if(lastSuggestions) doOptimize();
    });

    btnOptimize.addEventListener("click", doOptimize);
    btnApply.addEventListener("click", doApply);
    btnValidate.addEventListener("click", validateJSON);

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° EV ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    loadStats();
  </script>
</body>
</html>
